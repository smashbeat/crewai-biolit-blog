---
import Base from "../../layouts/Base.astro";
import { getCollection } from "astro:content";
import slugify from "../../utils/slugify";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const tagSet = new Set<string>();
  for (const p of posts) {
    for (const t of (p.data.tags || [])) tagSet.add(slugify(t));
  }
  return Array.from(tagSet).map((tag) => ({ params: { tag } }));
}

const { tag } = Astro.params;
const posts = await getCollection("posts");
const tagged = posts.filter(p => (p.data.tags || []).some(t => slugify(t) === tag));
const displayTag = tag.replace(/-/g, " ");
---

<Base title={`Tag: ${displayTag}`}>
  <h1>Tag: {displayTag}</h1>
  {tagged.length === 0 ? (
    <p>No posts found.</p>
  ) : (
    <ul>
      {tagged.map(p => (
        <li>
          <a href={`/posts/${p.slug}/`}>{p.data.title ?? p.slug}</a>
        </li>
      ))}
    </ul>
  )}
  <p style="margin-top:2rem"><a href="/">‚Üê Back to index</a></p>
</Base>
